resource "kubernetes_namespace" "laravel_notes" {
  metadata {
    name = var.namespace
    labels = {
      name        = var.namespace
      environment = "production"
    }
  }
}

resource "kubernetes_config_map" "laravel_config" {
  metadata {
    name      = "laravel-config"
    namespace = kubernetes_namespace.laravel_notes.metadata[0].name
  }

  data = {
    APP_NAME          = "Laravel Notes"
    APP_ENV           = "production"
    APP_DEBUG         = "false"
    APP_URL           = "http://localhost:8080"
    LOG_CHANNEL       = "stack"
    LOG_LEVEL         = "info"
    DB_CONNECTION     = "mysql"
    DB_HOST           = "mysql-service"
    DB_PORT           = "3306"
    DB_DATABASE       = var.db_name
    CACHE_STORE       = "redis"
    QUEUE_CONNECTION  = "redis"
    REDIS_HOST        = "redis-service"
    REDIS_PORT        = "6379"
    SESSION_DRIVER    = "redis"
    SESSION_LIFETIME  = "120"
  }
}

resource "kubernetes_secret" "laravel_secrets" {
  metadata {
    name      = "laravel-secrets"
    namespace = kubernetes_namespace.laravel_notes.metadata[0].name
  }

  data = {
    APP_KEY               = base64encode(var.app_key)
    DB_USERNAME           = base64encode(var.db_user)
    DB_PASSWORD           = base64encode(var.db_password)
    MYSQL_ROOT_PASSWORD   = base64encode("root")
    REDIS_PASSWORD        = base64encode("")
  }

  type = "Opaque"
}
